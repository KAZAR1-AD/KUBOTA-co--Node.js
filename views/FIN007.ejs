<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>検索結果（FIN007）</title>
    <link rel="stylesheet" href="/css/style.css"> 
</head>
<body class="fin007">

    <div class="fin007-title-bar" style="text-align: center; display: flex; justify-content: center; width: 100%;">
        <h2>検索結果</h2>
    </div>

    <div class="fin007-results-container">

        <% if (!shop || shop.length === 0) { %>
            <div style="text-align: center; padding: 20px;">
                <p>条件に合うお店が見つかりませんでした。</p>
            </div>
        <% } else { %>
            
            <% shop.forEach(item => { %>
            <div class="fin007-result-item">
                <span class="fin007-result-info">
                    <%= item.shop_name %> 
                    徒歩<%= Math.ceil(item.distance / 80) %>分<%= item.distance < 80 ? '以内' : '' %> 
                    予算：<%= item.budget %>円
                </span>
                <% if (isLoggedIn) { %>
                    <span class="fin007-result-star">
                        <img class="toggle-star"
                            src="<%= item.is_favorite !== 0 ? '/images/star.png' : '/images/star-bw.png' %>"
                            data-shop-id="<%= item.shop_id %>"
                            data-is-fav="<%= item.is_favorite %>"
                            data-on="/images/star.png"
                            data-off="/images/star-bw.png">
                    </span>
                <% } %>
            </div>
            <% }); %>

        <% } %>


        <% if (typeof totalPages !== 'undefined' && totalPages > 1) { %>
        <div class="pagination-container">
            <nav class="pagination">
                
                <% if (currentPage > 1) { %>
                    <a href="/search-results?page=<%= currentPage - 1 %>" class="pagination-link">
                        &laquo; 前へ
                    </a>
                <% } else { %>
                    <span class="pagination-link disabled">&laquo; 前へ</span>
                <% } %>


                <% for(let i = 1; i <= totalPages; i++) { %>
                    <% if (i === currentPage) { %>
                        <span class="pagination-link active"><%= i %></span>
                    <% } else { %>
                        <a href="/search-results?page=<%= i %>" class="pagination-link">
                            <%= i %>
                        </a>
                    <% } %>
                <% } %>


                <% if (currentPage < totalPages) { %>
                    <a href="/search-results?page=<%= currentPage + 1 %>" class="pagination-link">
                        次へ &raquo;
                    </a>
                <% } else { %>
                    <span class="pagination-link disabled">次へ &raquo;</span>
                <% } %>

            </nav>
        </div>
        <% } %>

    </div>

    <a href="/search" class="fin007-change-criteria-btn">
        条件<br>を変える
    </a>

    <script>
        const user_id = "<%= userId || '' %>";
    
        let debounceTimer;
    
        // お気に入り同期用関数（fetch）
        async function syncFavorites(shopIds) {
            if (!shopIds || shopIds.length === 0) return;

            try {
                const response = await fetch('/api/favorites/sync', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ userId: user_id, shopIds })
                });

                if (!response.ok) {
                    console.error('syncFavorites failed:', await response.text());
                } else {
                    console.log('syncFavorites success');
                }
            } catch (err) {
                console.error('fetch error:', err);
            }
        }

        // デバウンス付き送信
        function sendDebouncedFavorites(shopIds) {
            clearTimeout(debounceTimer);
            debounceTimer = setTimeout(() => {
                syncFavorites(shopIds);
            }, 500);
        }

        // 星アイコンのクリックイベント
        document.querySelectorAll(".toggle-star").forEach(img => {
            img.addEventListener("click", () => {
                // 現在の状態を反転
                const isFav = img.dataset.isFav === "1";
                img.dataset.isFav = isFav ? "0" : "1";
                img.src = isFav ? img.dataset.off : img.dataset.on;

                // 選択中のお気に入り shopId を取得
                const selected = Array.from(document.querySelectorAll(".toggle-star"))
                                    .filter(el => el.dataset.isFav === "1")
                                    .map(el => el.dataset.shopId);
                
                // デバウンス付きでサーバーに送信
                sendDebouncedFavorites(selected);
            });
        });

    </script>
    
    
</body>
</html>