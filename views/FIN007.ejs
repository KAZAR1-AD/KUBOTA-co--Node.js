<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-store, no-cache, must-revalidate">
    <title>検索結果（FIN007）</title>
    <link rel="stylesheet" href="/css/style.css">
    <style>
        /* --- 追加：ヘッダーの文字色とアニメーション --- */
        .fixed-header {
            transition: transform 0.4s ease, opacity 0.4s ease;
        }
        .fixed-header-title, 
        .fin001-welcome-msg,
        .fixed-header a {
            color: #FFFFFF !important;
            text-decoration: none;
        }
        .fixed-header a:hover {
            opacity: 0.7;
            transition: 0.2s;
        }
        .header-hidden {
            transform: translateY(-100%);
            opacity: 0;
        }

        /* --- 今回のポイント：クリック範囲の分離 --- */
        .fin007-result-item {
            display: flex; /* 横並びにする */
            align-items: center;
            padding: 0; /* 内側の余白は子要素で持たせる */
            overflow: hidden;
        }

        /* 左側：お店の情報（クリックでマップへ） */
        .fin007-result-info-link {
            flex-grow: 1; /* 残りの幅をすべて使う */
            padding: 15px; /* ここがクリックできる範囲 */
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .fin007-result-info-link:hover {
            background-color: rgba(0, 0, 0, 0.05);
        }

        /* 右側：お気に入り星マーク（ここは独立した範囲） */
        .fin007-result-star-box {
            padding: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .toggle-star {
            cursor: pointer;
        }
    </style>
</head>
<body class="fin007">

    <header class="fixed-header">
        <div class="fixed-header-left"></div>
        <div class="fixed-header-title">検索結果</div>
        <div class="fixed-header-icon-area">
            <% if (typeof isLoggedIn !=='undefined' && isLoggedIn) { %>
                <div class="fin001-user-controls">
                    <span class="fin001-welcome-msg"><%= userName %>さん</span>
                    <a href="/mypage?returnUrl=<%= encodeURIComponent(currentUrl) %>" class="header-profile-icon">
                        <img id="headerProfileImage" src="<%= userIconUrl %>" alt="メニュー">
                    </a>
                    <form action="/logout?returnUrl=<%= encodeURIComponent(currentUrl) %>" method="POST" style="display: inline;"
                        onsubmit="return confirm('ログアウトしますか？');">
                        <button type="submit" class="btn btn-default fin001-logout-btn">ログアウト</button>
                    </form>
                </div>
            <% } else { %>
                <a href="/welcome?returnUrl=<%= encodeURIComponent(currentUrl) %>" class="btn btn-default fin006-register-btn" role="button">ログイン</a>
                <a href="/register?returnUrl=<%= encodeURIComponent(currentUrl) %>" class="btn btn-default fin006-register-btn" role="button">新規登録</a>
            <% } %>
        </div>
    </header>

    <div class="fin007-results-container">
        <% if (!shop || shop.length === 0) { %>
            <div style="text-align: center; padding: 20px;">
                <p>条件に合うお店が見つかりませんでした。</p>
            </div>
        <% } else { %>
            <% shop.forEach(item => { %>
            <div class="fin007-result-item">
                <div class="fin007-result-info-link" onclick="handleMapClick('<%= item.shop_name %>', '<%= item.google_map_link %>')">
                    <span class="fin007-result-info">
                        <%= item.shop_name %> 
                        徒歩<%= Math.ceil(item.distance / 80) %>分<%= item.distance < 80 ? '以内' : '' %> 
                        予算：<%= item.budget %>円
                    </span>
                </div>

                <% if (isLoggedIn) { %>
                    <div class="fin007-result-star-box">
                        <span class="fin007-result-star">
                            <img class="toggle-star"
                                src="<%= Number(item.is_favorite) === 1 ? '/images/star.png' : '/images/star-bw.png' %>"
                                data-shop-id="<%= item.shop_id %>"
                                data-is-fav="<%= Number(item.is_favorite) === 1 ? '1' : '0' %>"
                                data-on="/images/star.png"
                                data-off="/images/star-bw.png">
                        </span>
                    </div>
                <% } %>
            </div>
            <% }); %>
        <% } %>

        <% if (typeof totalPages !== 'undefined' && totalPages > 1) { %>
        <div class="pagination-container">
            <nav class="pagination">
                <% if (currentPage > 1) { %>
                    <a href="/search-results?page=<%= currentPage - 1 %>" class="pagination-link">&laquo; 前へ</a>
                <% } %>
                <% for(let i = 1; i <= totalPages; i++) { %>
                    <a href="/search-results?page=<%= i %>" class="pagination-link <%= i === currentPage ? 'active' : '' %>">
                        <%= i %>
                    </a>
                <% } %>
                <% if (currentPage < totalPages) { %>
                    <a href="/search-results?page=<%= currentPage + 1 %>" class="pagination-link">次へ &raquo;</a>
                <% } %>
            </nav>
        </div>
        <% } %>
    </div>

    <a href="/search" class="fin007-change-criteria-btn">条件<br>を変える</a>

    <script>
        const USER_ID = "<%= userId %>";

        // --- マップ遷移の処理 ---
        function handleMapClick(shopName, mapUrl) {
            if (!mapUrl || mapUrl === 'undefined' || mapUrl === 'null' || mapUrl === '') {
                alert('このお店の地図リンクは登録されていません。');
                return;
            }

            if (confirm(shopName + ' の場所をGoogleマップで確認しますか？')) {
                window.open(mapUrl, '_blank');
            }
        }

        // --- スクロールでヘッダーを隠す処理 ---
        let lastScrollY = window.scrollY;
        const header = document.querySelector('.fixed-header');
        window.addEventListener('scroll', () => {
            if (window.scrollY > lastScrollY && window.scrollY > 50) {
                header.classList.add('header-hidden');
            } else {
                header.classList.remove('header-hidden');
            }
            lastScrollY = window.scrollY;
        });
    </script>
    <script src="/js/fav.js"></script>
</body>
</html>