<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>お店検索（FIN006）</title>
    <link rel="stylesheet" href="css/style.css">
</head>
<body class="fin006">

    <header class="fixed-header">
        <div class="fixed-header-left">
            </div>
        <div class="fixed-header-title">船橋今なにする？</div>
        <div class="fixed-header-icon-area">

            <% if (isLoggedIn) { %>
                <div class="fin001-user-controls">
                    <span class="fin001-welcome-msg"><%= userName %>さん</span>
                    
                    <a href="/mypage" class="header-profile-icon">
                        <!-- 修正箇所: サーバーから渡された userIconUrl を直接 src に設定 -->
                        <img id="headerProfileImage" src="<%= userIconUrl %>" alt="メニュー">
                    </a>    
                    <form action="/logout" method="POST" style="display: inline;">
                        <button type="submit" class="btn btn-default fin001-logout-btn">ログアウト</button>
                    </form>
                </div>

            <% } else { %>
                <a href="/FIN002" class="btn btn-default header-login-btn" role="button" id="headerLoginBtn">      
                    ログイン
                </a>
                <a href="/FIN003" class="btn btn-default fin006-register-btn" role="button">
                    新規登録
                </a>
            <% } %>
        </div>
    </header>
    
    <div class="container fin006-container"> 
        <h2 class="fin006-title">どんなお店をお探しですか？</h2>

        <div class="fin006-search-box">

            <div class="fin006-criteria-row">
                <label for="budget" class="fin006-label">1人当たりの予算</label>
                <div class="fin006-input-area">
                    <input type="range" id="budget" class="fin006-slider" min="1000" max="20000" value="1000" step="1000">
                    <span id="budgetValue" class="fin006-value-display">10,000円</span>
                </div>
            </div>

            <div class="fin006-criteria-row">
                <label for="distance" class="fin006-label">距離</label>
                <div class="fin006-input-area">
                    <select id="distance" class="fin006-select">
                        <option value="1">指定なし</option>
                        <option value="2">500m以内</option>
                        <option value="3">1km以内</option>
                        <option value="4">3km以内</option>
                    </select>
                </div>
            </div>

            <div class="fin006-criteria-row">
                <span class="fin006-label">ジャンル</span>
                <div class="fin006-input-area fin006-checkbox-group">
                    <label><input type="checkbox" name="genre" value="和食"> 和食</label>
                    <label><input type="checkbox" name="genre" value="洋食"> 洋食</label>
                    <label><input type="checkbox" name="genre" value="中華"> 中華</label>
                    <label><input type="checkbox" name="genre" value="居酒屋"> 居酒屋</label>
                    <label><input type="checkbox" name="genre" value="その他"> その他</label>
                </div>
            </div>
        </div>

        <div class="button-area button-area-center">
            <button class="btn btn-primary fin006-btn" onclick="execPost('/search', setValues());return false;">検索</button>
        </div>
    </div>

    <script src="js/execPost.js"></script>
    <script>
        // 予算スライダーの値表示を初期化・更新する関数
        function updateBudgetValue(value) {
            const display = document.getElementById('budgetValue');
            if (display) {
                display.textContent = parseInt(value).toLocaleString() + '円';
            }
        }

        // フォームの値を取得してオブジェクトにまとめる
        function setValues() {
            const budget = document.getElementById('budget').value;
            const distance = document.getElementById('distance').value;
            const genreElements = document.querySelectorAll('input[name="genre"]:checked');
            const genres = Array.from(genreElements).map(el => el.value);

            const values = {
                budget: budget,
                distance: distance,
                genre: genres
            };

            return values;
        }

        document.addEventListener('DOMContentLoaded', function () {
            // 予算スライダーのイベントリスナー設定
            const budgetSlider = document.getElementById('budget');
            if (budgetSlider) {
                // 初期値の表示
                updateBudgetValue(budgetSlider.value);

                // スライダーが動いたときの更新
                budgetSlider.addEventListener('input', function() {
                    updateBudgetValue(this.value);
                });
            }

            // ヘッダー関連のJavaScriptロジック
            // サーバーから渡された isLoggedIn 変数を使用
            // 修正: EJS変数が未定義の場合に備え、JavaScriptの構文エラーを防ぐために || false を追加
            const isLoggedIn = <%= isLoggedIn || false %>; 
            const loginBtn = document.getElementById('headerLoginBtn');

            // ログインボタンのリダイレクト処理（非ログイン時のみ）
            if (!isLoggedIn) {
                if (loginBtn) {
                    loginBtn.addEventListener('click', function (e) {
                        e.preventDefault();
                        const currentUrl = window.location.href;
                        // ログイン後、このページに戻るためのURLを保存
                        localStorage.setItem('redirectUrl', currentUrl);
                        window.location.href = e.target.href;
                    });
                }
            }
            
            // ログイン時のアイコン設定ロジックはEJSの src="<%= userIconUrl %>" に任せるため、
            // DOMContentLoaded 内のアイコンに関するJavaScriptロジックは削除しました。
        });
    </script>
</body>
</html>